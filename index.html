<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>BSLEEPY ‚Äî Quiz (Tema Escuro)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* * ATEN√á√ÉO: O CSS (ESTILIZA√á√ÉO) FOI OMITIDO AQUI POR BREVIDADE,
 * MAS ELE EST√Å PRESENTE NO C√ìDIGO ANTERIOR QUE VOC√ä TEM.
 * USE O CSS QUE VOC√ä J√Å TINHA, POIS ELE N√ÉO FOI ALTERADO.
 * Se precisar do CSS, me avise!
 */

/* --- CSS B√ÅSICO --- */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Poppins',sans-serif;
  background:linear-gradient(180deg,#0b0710 0%, #12061a 100%);
  color:#fff;
  display:flex;
  justify-content:center;
  padding:18px 12px;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.app{width:100%;max-width:420px;min-height:100vh;position:relative;overflow:hidden;border-radius:20px;}
.bg-dots{position:absolute;inset:0;background-image:radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px);background-size: 40px 40px;opacity:0.06;pointer-events:none;}
.topbar{height:64px;display:flex;align-items:center;gap:12px;padding:10px 14px;backdrop-filter: blur(6px);position:relative; z-index:40;}
.top-left{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.03);cursor:pointer;}
.progress-wrap{flex:1;height:8px;border-radius:999px;background:rgba(255,255,255,0.04);overflow:hidden}
.progress{height:100%;width:0;background:linear-gradient(90deg,#6f46ff,#5c32e5);transition:width .36s cubic-bezier(.2,.9,.25,1)}
.screen{position:absolute;left:0;right:0;top:64px;bottom:0;padding:24px;overflow:auto;transform:translateX(12%);opacity:0;pointer-events:none;transition:all .42s cubic-bezier(.2,.9,.25,1);z-index:10;}
.screen.active{transform:translateX(0);opacity:1;pointer-events:all}
.screen.left{transform:translateX(-8%);opacity:0}
.header{text-align:center;margin-top:6px;margin-bottom:14px;}
.header h1{font-size:22px;letter-spacing:0.2px;margin-bottom:8px}
.header p{color:rgba(255,255,255,0.72);font-size:13px}
.intro-card{margin-top:22px;border-radius:16px;padding:22px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));box-shadow:0 10px 30px rgba(10,6,20,0.35);display:flex;flex-direction:column;align-items:center;gap:12px;}
.card{margin-top:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:16px;box-shadow:0 8px 26px rgba(5,5,10,0.28);}
.input{width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-size:15px;outline:none;}
.options{display:flex;flex-direction:column;gap:12px;margin-top:8px}
.option{padding:14px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between;cursor:pointer;font-weight:600;transition:all .16s;}
.option.selected{background:linear-gradient(90deg,#6f46ff,#5c32e5);box-shadow:0 10px 30px rgba(92,50,229,0.12);border-color:rgba(255,255,255,0.06);color:#fff}
.footer{position:fixed;left:0;right:0;bottom:18px;display:flex;gap:14px;padding:12px 18px;align-items:center;justify-content:space-between;max-width:420px;margin:0 auto;z-index:50;pointer-events:all;}
.btn{padding:13px 18px;border-radius:12px;font-weight:700;border:0;cursor:pointer;}
.btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.06)}
.btn.primary{background:linear-gradient(90deg,#6f46ff,#5c32e5);color:#fff;box-shadow:0 12px 30px rgba(92,50,229,0.14)}
.btn.disabled{opacity:.45;cursor:not-allowed}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;}
.stat{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;text-align:center;}
.big{grid-column:1/-1;padding:16px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
.stat h3{font-size:13px;color:rgba(255,255,255,0.75)}
.stat p{font-weight:700;font-size:18px;margin-top:6px}
.modal{position:fixed;left:0;right:0;bottom:0;padding:18px;border-top-left-radius:18px;border-top-right-radius:18px;background:linear-gradient(180deg,#0b0811,#0f0718);box-shadow:0 -20px 60px rgba(5,5,10,0.6);transform:translateY(120%);transition:transform .36s cubic-bezier(.2,.9,.25,1);z-index:90;}
.modal.open{transform:translateY(0)}
.plan{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);}
.plan.selected{box-shadow:0 18px 40px rgba(92,50,229,0.12);border:1px solid rgba(92,50,229,0.18)}
.small{font-size:12px;color:rgba(255,255,255,0.7)}
.center{text-align:center}
[aria-hidden="true"]{display:none}
.input.error{border-color:#ff4646;box-shadow:0 0 0 2px rgba(255,70,70,0.1)}
.error-msg{color:#ff6666;font-size:12px;margin-top:6px;padding:0 10px;text-align:left;transition:all .2s;height:0;overflow:hidden;}
.error-msg.show{height:20px}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="BSLEEPY Quiz">
    <div class="bg-dots" aria-hidden="true"></div>

    <div id="topbar" class="topbar" style="display:none">
      <div id="backIcon" class="top-left" title="Voltar">&#8249;</div>
      <div class="progress-wrap" role="progressbar" aria-valuemin="0" aria-valuemax="100">
        <div id="progress" class="progress" style="width:0%"></div>
      </div>
    </div>

    <div id="intro" class="screen active" style="top:0; padding-top:40px; overflow-y:auto; -webkit-overflow-scrolling:touch;">
      <div class="header center">
        <h1 style="color:#fff; font-size:24px; margin-bottom:6px;">BSLEEPY</h1>
        <p style="font-size:14px; color:rgba(255,255,255,0.75); margin-bottom:12px;">Seu guia inteligente para noites melhores</p>
      </div>

      <div style="text-align:center; margin:8px 0 6px 0;">
        <button id="startBtnTop" class="btn primary" style="width:86%; max-width:360px;">Come√ßar Agora</button>
      </div>

      <div class="intro-card card" style="margin:12px 8px;">
        <div style="text-align:center; margin-bottom:12px;">
          <img src="logo.png" onerror="this.style.display='none';" alt="BSLEEPY" style="width:120px;height:auto;filter:drop-shadow(0 0 10px rgba(150,100,255,0.5));">
          <div class="logo" style="display:none">BS</div>
        </div>
        <div style="font-weight:700;font-size:18px;text-align:center">Sono mais profundo. Vida melhor.</div>
        <div class="small" style="color:rgba(255,255,255,0.68);text-align:center;margin-top:8px;">Responda um r√°pido quiz e receba um resumo gratuito com dicas f√°ceis de aplicar.</div>
        <button id="startBtn" class="btn primary" style="width:100%;margin-top:16px">Come√ßar Agora</button>
      </div>
      
      <div class="card" style="margin-top:18px;">
        <h2 style="font-size:17px;margin-bottom:8px;">Sobre a BSLEEPY</h2>
        <p style="font-size:14px;color:rgba(255,255,255,0.8);line-height:1.6;">
          A BSLEEPY foi criada para ajudar voc√™ a entender e melhorar o seu sono de forma simples e pr√°tica.
          Atrav√©s de um quiz r√°pido e um resumo gratuito, mostramos o que est√° afetando seu descanso e
          como melhorar suas noites com dicas reais e eficazes.
        </p>
      </div>

      <div class="card" style="margin-top:18px;">
        <h2 style="font-size:17px;margin-bottom:8px;">Benef√≠cios</h2>
        <ul style="list-style:none;padding:0;margin:0;color:rgba(255,255,255,0.8);font-size:14px;line-height:1.8;">
          <li>üåô Entenda suas dificuldades de sono</li>
          <li>üß† Receba dicas baseadas em h√°bitos reais</li>
          <li>üìä Veja seus resultados com gr√°ficos simples</li>
          <li>üí§ Acesse planos premium com acompanhamento</li>
        </ul>
      </div>

      <div style="text-align:center;margin:22px 0 40px 0;">
        <button id="startBtnBottom" class="btn primary" style="width:90%;max-width:360px;">Come√ßar Agora</button>
      </div>
    </div>

    <div id="signup" class="screen" aria-hidden="true" style="top:0; padding-top:60px;">
      <div class="header center">
        <h1>Crie sua conta</h1>
        <p>Salve seu progresso e receba um plano personalizado!</p>
      </div>

      <div class="card" style="margin-top:22px;">
        <button id="googleBtn" class="btn ghost" style="width:100%;margin-bottom:12px;border-color:rgba(255,255,255,0.1)">
          <img src="https://img.icons8.com/color/20/000000/google-logo.png" alt="Google" style="vertical-align:middle;margin-right:8px">
          Continuar com Google
        </button>
        <button id="facebookBtn" class="btn ghost" style="width:100%;border-color:rgba(255,255,255,0.1)" disabled>
          <img src="https://img.icons8.com/color/20/000000/facebook-new.png" alt="Facebook" style="vertical-align:middle;margin-right:8px">
          Continuar com Facebook (Em breve)
        </button>

        <div style="text-align:center;margin:20px 0 10px 0;color:rgba(255,255,255,0.4)">‚Äî OU ‚Äî</div>

        <input id="emailInput" class="input" type="email" placeholder="Seu melhor e-mail" aria-label="E-mail">
        <div id="emailError" class="error-msg">Por favor, insira um e-mail v√°lido.</div>

        <button id="continueEmailBtn" class="btn primary disabled" style="width:100%;margin-top:16px">
          Continuar com E-mail
        </button>

        <div class="small center" style="margin-top:16px;color:rgba(255,255,255,0.5)">
          J√° tem conta? <a href="#" id="loginLink" style="color:#6f46ff;text-decoration:none;">Fa√ßa Login</a>
        </div>
      </div>
    </div>
    
    <div id="password" class="screen" aria-hidden="true">
      <div class="header">
        <h1 id="passwordTitle"></h1>
        <p id="passwordSubtitle"></p>
      </div>
      <div class="card">
        <input id="passwordInput" class="input" type="password" placeholder="Sua senha" aria-label="Senha">
        <div id="passwordError" class="error-msg">A senha deve ter pelo menos 6 caracteres.</div>
        <button id="authActionBtn" class="btn primary disabled" style="width:100%;margin-top:20px">
          Criar Conta / Entrar
        </button>
      </div>
      <div class="small center" style="margin-top:16px;color:rgba(255,255,255,0.5)">
        <a href="#" id="forgotPasswordLink" style="color:#6f46ff;text-decoration:none;">Esqueci minha senha</a>
      </div>
    </div>

    <div id="q1" class="screen" aria-hidden="true">
      <div class="header">
        <h1>Qual √© o seu nome?</h1>
        <p>Vamos personalizar o resultado.</p>
      </div>
      <div class="card">
        <input id="nameInput" class="input" type="text" placeholder="Ex: Ana" aria-label="Nome">
      </div>
    </div>

    <div id="q2" class="screen" aria-hidden="true">
      <div class="header">
        <h1>Qual sua idade?</h1>
        <p>A idade ajuda a refinar as recomenda√ß√µes.</p>
      </div>
      <div class="card">
        <input id="ageInput" class="input" type="number" min="10" max="120" placeholder="Ex: 28" aria-label="Idade">
      </div>
    </div>

    <div id="q3" class="screen" aria-hidden="true">
      <div class="header">
        <h1>Qual √© seu peso (kg)?</h1>
        <p>Opcional ‚Äî afeta sugest√µes de atividade.</p>
      </div>
      <div class="card">
        <input id="weightInput" class="input" type="number" min="20" max="400" placeholder="Ex: 72" aria-label="Peso">
      </div>
    </div>

    <div id="q4" class="screen" aria-hidden="true">
      <div class="header">
        <h1>Voc√™ tem dificuldade para pegar no sono?</h1>
        <p>Escolha a melhor op√ß√£o.</p>
      </div>
      <div class="card">
        <div id="insomnia" class="options">
          <div class="option" data-val="freq"><span class="label">Sim, frequentemente</span></div>
          <div class="option" data-val="ocas"><span class="label">√Äs vezes</span></div>
          <div class="option" data-val="nao"><span class="label">N√£o</span></div>
        </div>
      </div>
    </div>

    <div id="q5" class="screen" aria-hidden="true">
      <div class="header">
        <h1>Voc√™ usa celular antes de dormir?</h1>
        <p>Isso influencia a qualidade do sono.</p>
      </div>
      <div class="card">
        <div id="phone" class="options">
          <div class="option" data-val="sempre"><span class="label">Sempre</span></div>
          <div class="option" data-val="asvezes"><span class="label">√Äs vezes</span></div>
          <div class="option" data-val="nunca"><span class="label">Raramente / Nunca</span></div>
        </div>
      </div>
    </div>

    <div id="q6" class="screen" aria-hidden="true">
      <div class="header">
        <h1>Quantas horas dorme por noite em m√©dia?</h1>
        <p>Estimativa semanal.</p>
      </div>
      <div class="card">
        <div id="hours" class="options">
          <div class="option" data-val="lt5"><span class="label">Menos de 5h</span></div>
          <div class="option" data-val="5_7"><span class="label">Entre 5h e 7h</span></div>
          <div class="option" data-val="gt7"><span class="label">Mais de 7h</span></div>
        </div>
      </div>
    </div>

    <div id="q7" class="screen" aria-hidden="true">
      <div class="header">
        <h1>Voc√™ acorda se sentindo descansado?</h1>
        <p>R√°pido e objetivo.</p>
      </div>
      <div class="card">
        <div id="rested" class="options">
          <div class="option" data-val="sim"><span class="label">Sim</span></div>
          <div class="option" data-val="asvezes"><span class="label">√Äs vezes</span></div>
          <div class="option" data-val="nao"><span class="label">N√£o</span></div>
        </div>
      </div>
    </div>

    <div id="result" class="screen" aria-hidden="true">
      <div class="header center">
        <h1 id="resultTitle">Seu resumo gratuito</h1>
        <p id="resultSubtitle">Sugest√µes r√°pidas para melhorar sua noite</p>
      </div>

      <div class="big card">
        <div>
          <div style="font-weight:800;font-size:18px" id="greetName">Ol√°!</div>
          <div class="small" id="greetSub">Analisando suas respostas...</div>
        </div>
        <div style="width:92px;height:92px">
          <canvas id="chartSleep" width="92" height="92"></canvas>
        </div>
      </div>

      <div class="grid">
        <div class="stat">
          <h3>Horas</h3>
          <p id="statHours">‚Äî</p>
        </div>
        <div class="stat">
          <h3>Ins√¥nia</h3>
          <p id="statInsomnia">‚Äî</p>
        </div>
        <div class="stat">
          <h3>Uso do celular</h3>
          <p id="statPhone">‚Äî</p>
        </div>
        <div class="stat">
          <h3>Acordar</h3>
          <p id="statRest">‚Äî</p>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div style="margin-top:18px;text-align:center">
          <button id="seePlansBtn" class="btn primary" style="width:100%">Ver planos premium</button>
        </div>
        <div style="font-weight:700">Dicas r√°pidas</div>
        <ul style="margin-top:10px;list-style:none;padding-left:0;color:rgba(255,255,255,0.82)">
          <li style="margin-bottom:8px">‚Ä¢ Evite telas 60 min antes de dormir.</li>
          <li style="margin-bottom:8px">‚Ä¢ Mantenha hor√°rio fixo para deitar e acordar.</li>
          <li style="margin-bottom:8px">‚Ä¢ Reduza cafe√≠na ap√≥s 16h.</li>
        </ul>
      </div>
    </div>

    <div id="footer" class="footer" style="display:none">
      <button id="backBtn" class="btn ghost">Voltar</button>
      <button id="nextBtn" class="btn primary disabled">Continuar</button>
    </div>

    <div id="plans" class="modal" aria-hidden="true">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div style="font-weight:800;font-size:18px">Monitore diariamente</div>
          <div class="small" style="margin-top:6px">Plano com rotinas personalizadas e acompanhamento</div>
        </div>
        <div style="font-weight:800">R$ 12,49</div>
      </div>

      <div id="planAnnual" class="plan selected">
        <div>
          <div style="font-size:12px;background:#5c32e5;padding:6px 8px;border-radius:999px;display:inline-block;margin-bottom:6px">MAIS POPULAR</div>
          <div style="font-weight:700">Plano Anual</div>
          <div class="small">Pagamento √∫nico ‚Äî melhor custo</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800">R$ 12,49</div>
          <div class="small">/ m√™s</div>
        </div>
      </div>

      <div id="planMonthly" class="plan">
        <div>
          <div style="font-weight:700">Plano Mensal</div>
          <div class="small">Cancele a qualquer momento</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:800">R$ 37,90</div>
          <div class="small">/ m√™s</div>
        </div>
      </div>

      <button id="buyBtn" class="btn primary" style="width:100%;margin-top:8px">COME√áAR MINHA JORNADA üîí</button>
      <div style="display:flex;gap:14px;justify-content:center;margin-top:12px">
        <a href="#" class="small" style="color:rgba(255,255,255,0.6)">Termos</a>
        <a href="#" class="small" style="color:rgba(255,255,255,0.6)">Privacidade</a>
      </div>
    </div>

  </div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<script>
  // ESTAS S√ÉO AS CHAVES REAIS DO SEU PROJETO BSLEEPY NO FIREBASE
  const firebaseConfig = {
    apiKey: "AIzaSyDAgoggqLeNhIo-uegWR5XNvWAjqg3tspM",
    authDomain: "bsleepy-1bd3a.firebaseapp.com",
    projectId: "bsleepy-1bd3a",
    storageBucket: "bsleepy-1bd3a.firebasestorage.app",
    messagingSenderId: "479557982873",
    appId: "1:479557982873:web:db544c32080869ac51f608",
    measurementId: "G-4GE5YM55TH"
  };

  // Inicializa o Firebase
  firebase.initializeApp(firebaseConfig);
  // Inicializa o servi√ßo de autentica√ß√£o
  const auth = firebase.auth();
  let currentAuthMode = 'signup'; // 'signup' ou 'login'

  let currentUserEmail = ''; 
</script>
<script>
/* ---------- State & elements (Mantidos) ---------- */
const steps = ['intro','signup','password','q1','q2','q3','q4','q5','q6','q7','result'];
let step = 0;
const answers = { name:'', age:'', weight:'', insomnia:'', phone:'', hours:'', rested:'' };

/* DOM */
const topbar = document.getElementById('topbar');
const progress = document.getElementById('progress');
const footer = document.getElementById('footer');
const backIcon = document.getElementById('backIcon');
const startBtn = document.getElementById('startBtn'); 
const nextBtn = document.getElementById('nextBtn');
const backBtn = document.getElementById('backBtn');

/* NOVOS ELEMENTOS DOM para Login/Cadastro */
const googleBtn = document.getElementById('googleBtn');
const facebookBtn = document.getElementById('facebookBtn');
const emailInput = document.getElementById('emailInput');
const emailError = document.getElementById('emailError');
const continueEmailBtn = document.getElementById('continueEmailBtn');
const loginLink = document.getElementById('loginLink');
const passwordInput = document.getElementById('passwordInput');
const passwordError = document.getElementById('passwordError');
const passwordTitle = document.getElementById('passwordTitle');
const passwordSubtitle = document.getElementById('passwordSubtitle');
const authActionBtn = document.getElementById('authActionBtn'); 
const forgotPasswordLink = document.getElementById('forgotPasswordLink');

/* screen elements */
function screenEl(id){ return document.getElementById(id); }
const nameInput = document.getElementById('nameInput');
const ageInput = document.getElementById('ageInput');
const weightInput = document.getElementById('weightInput');

const insomniaOpts = document.getElementById('insomnia');
const phoneOpts = document.getElementById('phone');
const hoursOpts = document.getElementById('hours');
const restedOpts = document.getElementById('rested');

const resultTitle = document.getElementById('resultTitle');
const greetName = document.getElementById('greetName');
const greetSub = document.getElementById('greetSub');
const statHours = document.getElementById('statHours');
const statInsomnia = document.getElementById('statInsomnia');
const statPhone = document.getElementById('statPhone');
const statRest = document.getElementById('statRest');

const plansModal = document.getElementById('plans');
const buyBtn = document.getElementById('buyBtn');
const planAnnual = document.getElementById('planAnnual');
const planMonthly = document.getElementById('planMonthly');

/* chart */
let sleepChart = null;

/* ---------- Helpers (Mantidos) ---------- */
function showStep(i){
  if(i < 0) i = 0;
  if(i >= steps.length) i = steps.length - 1;
  const prevStep = step;
  step = i;

  if(steps[step] === 'intro'){
    topbar.style.display = 'none'; footer.style.display = 'none';
  } else {
    topbar.style.display = 'flex'; footer.style.display = 'flex';
  }

  steps.forEach(s => {
    const el = screenEl(s);
    if(!el) return;
    el.classList.remove('active');
    el.setAttribute('aria-hidden','true');
  });
  const curr = screenEl(steps[step]);
  if(curr){
    curr.classList.add('active');
    curr.setAttribute('aria-hidden','false');
    if (steps[step] === 'password') passwordInput.focus();
  }

  const quizSteps = steps.slice(steps.indexOf('q1'));
  const currentQuizStep = quizSteps.indexOf(steps[step]);
  
  let pct = 0;
  if(currentQuizStep >= 0){
    pct = Math.round((currentQuizStep) / (quizSteps.length - 1) * 100);
  }
  
  progress.style.width = pct + '%';

  if(step === 0){ backBtn.disabled = true; backBtn.classList.add('btn-disabled'); }
  else { backBtn.disabled = false; backBtn.classList.remove('btn-disabled'); }

  validateCurrent();
  window.scrollTo({top:0,behavior:'smooth'});
}

function nextStep(){
  if(!validateCurrent()) return;
  if(step < steps.length - 1) showStep(step + 1);
  if(steps[step] === 'result') renderResult();
}

function prevStep(){
  if(step > 0) showStep(step - 1);
}

/* --- L√≥gica de Valida√ß√£o (Mantida) --- */
function validatePassword(pass) {
    return pass.length >= 6;
}

function validateEmail(email){
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim());
}

function validateCurrent(){
  const curr = steps[step];
  let ok = false;
  
  if(emailInput) emailInput.classList.remove('error');
  if(passwordInput) passwordInput.classList.remove('error');
  if(passwordError) passwordError.classList.remove('show');

  if(curr === 'intro') ok = true;
  
  if(curr === 'signup'){
    const isEmailValid = validateEmail(emailInput.value);
    
    if(emailInput.value.trim().length > 0 && !isEmailValid){
      emailInput.classList.add('error');
      emailError.innerText = 'Por favor, insira um e-mail v√°lido.';
      emailError.classList.add('show');
    } else {
      emailInput.classList.remove('error');
      emailError.classList.remove('show');
    }

    if(isEmailValid){
      continueEmailBtn.classList.remove('disabled');
      continueEmailBtn.disabled = false;
    } else {
      continueEmailBtn.classList.add('disabled');
      continueEmailBtn.disabled = true;
    }
    ok = true; 
  }
  
  if(curr === 'password') {
    const pass = passwordInput.value;
    ok = validatePassword(pass);
    
    authActionBtn.classList.toggle('disabled', !ok);
    authActionBtn.disabled = !ok;
    
    if(!ok && pass.length > 0){
      passwordInput.classList.add('error');
      passwordError.innerText = 'A senha deve ter pelo menos 6 caracteres.';
      passwordError.classList.add('show');
    }
  }

  if(curr === 'q1') ok = (nameInput.value.trim().length >= 2);
  if(curr === 'q2') ok = (ageInput.value && Number(ageInput.value) >= 10);
  if(curr === 'q3') ok = (!weightInput.value || (Number(weightInput.value) >= 20 && Number(weightInput.value) < 400));
  if(curr === 'q4') ok = !!answers.insomnia;
  if(curr === 'q5') ok = !!answers.phone;
  if(curr === 'q6') ok = !!answers.hours;
  if(curr === 'q7') ok = !!answers.rested;
  if(curr === 'result') ok = true;
  
  if(curr === 'signup' || curr === 'password' || curr === 'intro'){ 
     nextBtn.classList.add('disabled');
     nextBtn.disabled = true;
  } else {
     if(ok){ nextBtn.classList.remove('disabled'); nextBtn.disabled = false; } else { nextBtn.classList.add('disabled'); nextBtn.disabled = true; }
  }
  
  return ok;
}

// --- FUN√á√ïES DE AUTENTICA√á√ÉO FIREBASE REAIS ---

// 1. Login/Cadastro com Google
googleBtn.addEventListener('click', () => {
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider)
    .then((result) => {
      alert(`Login com Google bem-sucedido para: ${result.user.email}`);
      showStep(steps.indexOf('q1'));
    })
    .catch((error) => {
      alert(`Erro no Login com Google: ${error.message}`);
    });
});

// 2. Continua com E-mail (Verifica se √© Login ou Cadastro)
continueEmailBtn.addEventListener('click', () => {
    if(continueEmailBtn.disabled) return;

    const email = emailInput.value.trim();
    currentUserEmail = email;

    auth.fetchSignInMethodsForEmail(email)
        .then((methods) => {
            if (methods.length > 0) {
                // E-mail J√Å EXISTE: MODO LOGIN
                currentAuthMode = 'login';
                passwordTitle.innerText = 'Bem-vindo(a) de volta!';
                passwordSubtitle.innerText = `Entre com sua senha para ${email}`;
                authActionBtn.innerText = 'Entrar';
                forgotPasswordLink.style.display = 'block';
            } else {
                // E-mail N√ÉO EXISTE: MODO CADASTRO (SIGNUP)
                currentAuthMode = 'signup';
                passwordTitle.innerText = 'Crie sua senha';
                passwordSubtitle.innerText = `Cadastre sua senha para ${email}`;
                authActionBtn.innerText = 'Criar Conta';
                forgotPasswordLink.style.display = 'none';
            }
            passwordInput.value = '';
            showStep(steps.indexOf('password'));
        })
        .catch((error) => {
            alert("Erro ao verificar e-mail: " + error.message);
        });
});

// 3. A√ß√£o de Autentica√ß√£o (Login ou Cadastro)
authActionBtn.addEventListener('click', () => {
    if(authActionBtn.disabled) return;

    const email = currentUserEmail;
    const password = passwordInput.value;

    if (currentAuthMode === 'signup') {
        // MODO CADASTRO: Cria a conta
        auth.createUserWithEmailAndPassword(email, password)
            .then(() => {
                alert(`Cadastro conclu√≠do para ${email}! Agora voc√™ pode come√ßar o Quiz.`);
                showStep(steps.indexOf('q1'));
            })
            .catch((error) => {
                let msg = error.message;
                if(error.code === 'auth/weak-password') msg = 'A senha √© muito fraca (m√≠nimo 6 caracteres).';
                alert(`Erro no Cadastro: ${msg}`);
            });
    } else {
        // MODO LOGIN: Tenta entrar
        auth.signInWithEmailAndPassword(email, password)
            .then(() => {
                alert(`Login bem-sucedido para ${email}!`);
                showStep(steps.indexOf('q1'));
            })
            .catch((error) => {
                let msg = error.message;
                if(error.code === 'auth/wrong-password') msg = 'Senha incorreta.';
                if(error.code === 'auth/user-not-found') msg = 'Usu√°rio n√£o encontrado.';
                alert(`Erro no Login: ${msg}`);
            });
    }
});

// 4. Reset de Senha
forgotPasswordLink.addEventListener('click', (e) => {
    e.preventDefault();
    if(currentUserEmail){
        auth.sendPasswordResetEmail(currentUserEmail)
            .then(() => {
                alert(`E-mail de redefini√ß√£o enviado para ${currentUserEmail}! Verifique sua caixa de entrada.`);
            })
            .catch((error) => {
                alert(`Erro ao enviar e-mail: ${error.message}`);
            });
    } else {
        alert("Volte para a tela anterior e insira seu e-mail.");
    }
});


/* --- EVENT LISTENERS GERAIS (Mantidos) --- */
if (startBtn) {
  startBtn.addEventListener('click', ()=>{
    const intro = document.getElementById('intro');
    if(intro){
      intro.style.transition = 'transform .36s ease, opacity .36s ease';
      intro.style.transform = 'translateY(-6%)';
      intro.style.opacity = '0';
      setTimeout(()=> {
        intro.style.transform = '';
        intro.style.opacity = '';
        showStep(steps.indexOf('signup'));
      }, 360);
    } else {
      showStep(steps.indexOf('signup'));
    }
  });
}

document.getElementById('startBtnTop').addEventListener('click', ()=> document.getElementById('startBtn').click());
document.getElementById('startBtnBottom').addEventListener('click', ()=> document.getElementById('startBtn').click());

backBtn.addEventListener('click', ()=> prevStep());
backIcon.addEventListener('click', ()=> prevStep());

nextBtn.addEventListener('click', (ev)=> {
  if(nextBtn.classList.contains('disabled')) {
    ev.preventDefault();
    return;
  }
  nextStep();
});

nameInput.addEventListener('input', ()=>{ validateCurrent(); });
ageInput.addEventListener('input', ()=>{ validateCurrent(); });
weightInput.addEventListener('input', ()=>{ validateCurrent(); });
emailInput.addEventListener('input', ()=>{ validateCurrent(); });
passwordInput.addEventListener('input', ()=>{ validateCurrent(); });
loginLink.addEventListener('click', (e) => {
    e.preventDefault();
    // Simula Login Link: Pula para a tela de senha em modo 'login'
    currentUserEmail = emailInput.value.trim();
    currentAuthMode = 'login';
    passwordTitle.innerText = 'Bem-vindo(a) de volta!';
    passwordSubtitle.innerText = `Entre com sua senha para ${currentUserEmail || 'seu e-mail'}`;
    authActionBtn.innerText = 'Entrar';
    forgotPasswordLink.style.display = 'block';
    showStep(steps.indexOf('password'));
});

function wireOptions(container, key){
  if(!container) return;
  container.querySelectorAll('.option').forEach(o=>{
    o.addEventListener('click', ()=>{
      container.querySelectorAll('.option').forEach(x=>x.classList.remove('selected'));
      o.classList.add('selected');
      answers[key] = o.getAttribute('data-val');
      validateCurrent();
      
      if(key !== 'password' && key !== 'name' && key !== 'age' && key !== 'weight'){
        setTimeout(()=>{ nextStep(); }, 220); 
      }
    });
  });
}
wireOptions(insomniaOpts,'insomnia');
wireOptions(phoneOpts,'phone');
wireOptions(hoursOpts,'hours');
wireOptions(restedOpts,'rested');

/* --- RESULTADO E CHART (Mantidos) --- */
function renderResult(){
  answers.name = nameInput.value.trim() || 'Amigo';
  answers.age = ageInput.value.trim();
  answers.weight = weightInput.value.trim();

  greetName.innerText = `Ol√°, ${answers.name}!`;
  greetSub.innerText = `Resumo r√°pido com base nas suas respostas`;

  const hoursMap = { 'lt5':'<5h', '5_7':'5-7h','gt7':'>7h' };
  statHours.innerText = hoursMap[answers.hours] || '‚Äî';
  const insomniaMap = { 'freq':'Frequente','ocas':'Ocasional','nao':'N√£o' };
  statInsomnia.innerText = insomniaMap[answers.insomnia] || '‚Äî';
  const phoneMap = { 'sempre':'Sempre','asvezes':'√Äs vezes','nunca':'Raramente' };
  statPhone.innerText = phoneMap[answers.phone] || '‚Äî';
  const restMap = { 'sim':'Sim','asvezes':'√Äs vezes','nao':'N√£o' };
  statRest.innerText = restMap[answers.rested] || '‚Äî';

  let summary = '';
  if(answers.insomnia === 'freq'){ summary += 'Sinais de ins√¥nia frequente. '; } else if(answers.hours === 'lt5'){ summary += 'Seu tempo de sono √© baixo. '; } else { summary += 'Seu sono parece dentro do esperado. '; }
  if(answers.phone === 'sempre') summary += 'Reduza telas 60 min antes de dormir. ';
  if(answers.rested === 'nao') summary += 'Tente rotina fixa de hor√°rio. ';

  resultTitle.innerText = 'Resumo gratuito';
  document.getElementById('greetSub').innerText = summary || 'Pequenos ajustes podem melhorar seu sono.';

  const sleepScore = calcSleepScore();
  drawChart(sleepScore);
}

function calcSleepScore(){
  let score = 80;
  if(answers.hours === 'lt5') score -= 40;
  if(answers.hours === '5_7') score -= 10;
  if(answers.insomnia === 'freq') score -= 30;
  if(answers.phone === 'sempre') score -= 10;
  if(answers.rested === 'sim') score += 6;
  score = Math.max(8, Math.min(98, Math.round(score)));
  return score;
}

function drawChart(value){
  const ctx = document.getElementById('chartSleep').getContext('2d');
  if(sleepChart) sleepChart.destroy();
  sleepChart = new Chart(ctx, {
    type:'doughnut',
    data:{ datasets:[{ data:[value, 100-value], backgroundColor:['#5c32e5','#15141a'], borderWidth:0 }]},
    options:{
      cutout: '68%',
      plugins:{legend:{display:false},tooltip:{enabled:false}},
      elements:{arc:{borderWidth:0}}
    }
  });
}

/* --- PLANS (Mantidos) --- */
function openPlans(){ plansModalOpen(true); }
function plansModalOpen(open){
  if(open){
    plansModal.classList.add('open');
    plansModal.setAttribute('aria-hidden','false');
    buyBtn.onclick = ()=> {
      const plan = planAnnual.classList.contains('selected') ? 'Anual' : 'Mensal';
      alert(`Iniciando checkout para: ${plan}\nSubstitua este alert pelo link real do Mercado Pago.`);
    };
  } else {
    plansModal.classList.remove('open');
    plansModal.setAttribute('aria-hidden','true');
  }
}
planAnnual.addEventListener('click', ()=>{ planAnnual.classList.add('selected'); planMonthly.classList.remove('selected'); });
planMonthly.addEventListener('click', ()=>{ planMonthly.classList.add('selected'); planAnnual.classList.remove('selected'); });
const seePlansBtn = document.getElementById('seePlansBtn');
if (seePlansBtn) seePlansBtn.addEventListener('click', ()=> openPlans());


/* ---------- Initial state (Mantido) ---------- */
// Ouve mudan√ßas de estado do usu√°rio do Firebase (importante!)
auth.onAuthStateChanged(user => {
    if (user) {
        console.log("Usu√°rio logado:", user.email);
        nameInput.value = user.displayName || user.email.split('@')[0]; 
    } else {
        console.log("Nenhum usu√°rio logado.");
    }
    showStep(0);
});

/* Acessibilidade: keyboard */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowRight' && steps[step].startsWith('q') && nextBtn.disabled === false) nextStep();
  if(e.key === 'ArrowLeft') prevStep();
});

</script>
</body>
</html>
